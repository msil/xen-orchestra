// @flow

import { dirname } from 'path'
import { mkdir, stat } from 'fs'
import { promisify } from 'promise-toolbox'

const simpleMkdirp = (
  path: string,
  cb: (error: ?Error) => void
) => mkdir(path, undefined, error => {
  if (error == null) {
    return cb()
  }

  if (error.code === 'ENOENT') {
    return simpleMkdirp(dirname(path), error =>
      error != null ? cb(error) : simpleMkdirp(path, cb)
    )
  }

  return stat(path, (_, stats) =>
    stats != null && stats.isDirectory() ? cb() : cb(error)
  )
})

export default promisify(simpleMkdirp)
